---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
x <- c(1, 2, 3, NA)
x
(y <- x[1] + x[2] + x[3] + x[4])
y
(z <- sum(x))
z
(z <- sum(x, na.rm = TRUE))
z
is.na(x)
which(is.na(x))

manager <- c(1, 2, 3, 4, 5)
manager
date <- c("10/24/08", "10/28/08", "10/1/08", "10/12/08",
"5/1/09")
country <- c("US", "US", "UK", "UK", "UK")
gender <- c("M", "F", "F", "M", "F")
age <- c(32, 45, 25, 39, 99)
q1 <- c(5, 3, 3, 3, 2)
q2 <- c(4, 5, 5, 3, 2)
q3 <- c(5, 2, 5, 4, 1)
q4 <- c(5, 5, 5, NA, 2)
q5 <- c(5, 5, 2, NA, 1)

leadership <-data.frame(manager, date, country, gender, age, q1, q2, q3, q4, q5, stringsAsFactors = FALSE)

# 二維資料表遺缺值辨識
is.na(leadership[,6:10])
```
```{r}

newdata <- na.omit(leadership)

newdata
is.na(newdata[,6:10])
```
```{r}
library(DMwR2) # library(DMwR2)
data(algae)
str(algae)
```

```{r}
algae
is.na(algae$mxPH)[1:48]
```


## 

```{r}
which(is.na(algae$mxPH))
```
```{r}

# 直接移除NA並另存為mxPH.na.omit
mxPH.na.omit <- na.omit(algae$mxPH)
                        
length(mxPH.na.omit)
# 說明遺缺值處理方式的詮釋資料
attributes(mxPH.na.omit)
```
# 有NA就報錯的處理方式na.fail()
```{r}

# na.fail(algae$mxPH)

```
```{r}
library(mice)
library(VIM)

aggr(algae, prop = FALSE, numbers = TRUE, cex.axis = .5) # 長條圖 + 熱圖/長條圖

```
```{r}

complete.cases(algae)[1:60]

```
## 邏輯否定運算子搭配which()函數，抓出不完整樣本位置
```{r}
which(!complete.cases(algae))
```
## 取出不完整的樣本加以檢視\
```{r}
algae[which(!complete.cases(algae)),]
```
# 也可以用邏輯值索引取出不完整的樣本(請自行練習)
```{r}
 algae[!complete.cases(algae),]
```
## 以邏輯值索引移除不完整的觀測值

```{r}
algae1 <- algae[complete.cases(algae),]
algae1
```
```{r}
# 統計各樣本遺缺變數個數
apply(algae, MARGIN = 1, FUN = function(x) {sum(is.na(x))})

```
# 結果與complete.cases()一致
```{r}

which(apply(algae, MARGIN = 1, FUN = function(x)
{sum(is.na(x))}) > 0)
```
```{r}
## ------------------------------------------------------------------------
data(algae)
# 返回遺缺變數數量超過20%以上(nORp=0.2)的樣本編號
manyNAs(algae, nORp = 0.2)
# 負索引刪除遺缺程度較嚴重的樣本
# Python語言以DataFrame之drop()方法刪除
algae <- algae[-manyNAs(algae),]

```

```{r}
## ----fig.align="center", fig.cap = "\\label{fig:algae_mxPH}最大酸鹼值mxPH散佈狀況圖", warning = FALSE, message=FALSE----
library(car) # J. Fox and S. Weisberg, An R Companion to Applied Regression, Third Edition, Sage, 2019.
# 圖面切分一列兩行(mfrow=c(1,2))，cex.main主標題文字縮小70%
par(mfrow = c(1, 2), cex.main = 0.7)
```
```{r}
# 左行高階繪圖(直方圖)
hist(algae$mxPH, prob = T, xlab = '', main =
'Histogram of maximum pH value', ylim = 0:1)
```
# 左行低階繪圖兩次(密度曲線加一維散佈刻度)
```{r}
# 左行高階繪圖(直方圖)
hist(algae$mxPH, prob = T, xlab = '', main =
'Histogram of maximum pH value', ylim = 0:1)
# 左行低階繪圖兩次(密度曲線加一維散佈刻度)
lines(density(algae$mxPH, na.rm = T))
rug(jitter(algae$mxPH))
```

```{r}
# 右行高階繪圖(常態機率繪圖，點靠近斜直線表近似常態分佈)
qqPlot(algae$mxPH, main = 'Normal QQ plot of maximum pH')
# 還原圖面一列一行原始設定
par(mfrow = c(1,1))

```

# 用自己的算術平均數填補遺缺值
```{r}
algae[48,'mxPH'] <- mean(algae$mxPH, na.rm = T)
## ----fig.align="center", fig.cap = "\\label{fig:algae_Chla}葉綠素Chla散佈狀況圖", warning = FALSE, message=FALSE----
par(mfrow = c(1,2))
hist(algae$Chla, prob = T, xlab='', main='Histogram of Chla')
lines(density(algae$Chla,na.rm = T))
rug(jitter(algae$Chla))
```


# 順帶返回偏離嚴重的樣本編號

```{r}
qqPlot(algae$Chla,main = 'Normal QQ plot of Chla')
par(mfrow = c(1,1))
```

# 用自己的中位數填補遺缺值
```{r}

algae[is.na(algae$Chla),'Chla'] <- median(algae$Chla,na.rm = T)

```

## ------------------------------------------------------------------------
```{r}
data(algae)

```
# 移除遺缺狀況嚴重的樣本

```{r}
algae <- algae[-manyNAs(algae),]
```

# 檢視遺缺狀況較不嚴重的樣本
```{r}
algae[!complete.cases(algae),]
```

# 用各欄位自身的集中趨勢資訊進行填補
```{r}
algae <- centralImputation(algae)
algae
```

# 已無不完整的樣本了！
```{r}
algae[!complete.cases(algae),]
algae
```
```{r}
library(Hmisc)
data(algae)
```
# 以算術平均數填補mxPH遺缺值，星號顯示填補位置

```{r}
impute(algae$mxPH, fun = mean)[40:55]

```
# Chla有遺缺值
```{r}
summary(algae$Chla)
```

# 以中位數填補Chla遺缺值
```{r}
impute(algae$Chla, fun = median)[50:65]
```

# 以固定數值45填補Chla遺缺值
```{r}
impute(algae$Chla, fun = 45)[50:65]
```

# 以隨機產生的數值填補Chla遺缺值
```{r}
impute(algae$Chla, fun = "random")[50:65]
```
## ------------------------------------------------------------------------
# "complete.obs"選項使用完整觀測值計算兩兩變數的相關係數
```{r}
cor(algae[,4:18], use = "complete.obs")[6:11,6:11]
```

# "everything"用全部的觀測值計算相關係數，可能返回NA值
```{r}
cor(algae[,4:18], use = "everything")[6:11,6:11]

```

# "all.obs"選項當觀測值中有NAs時會返回錯誤訊息
# cor(algae[,4:18], use = "all.obs")
# Error in cor(algae[, 4:18], use = "all.obs") :
# missing observations in cov/cor
```{r}
## ------------------------------------------------------------------------
# "pairwise.complete.obs"選項使用成對完整的觀測值計算相關係數
cor(algae[,4:18], use = "pairwise.complete.obs")[6:11,6:11]
```

# pairwise.complete.obs與complete.obs兩者計算結果不完全相同！
```{r}
cor(algae[,4:18], use = "pairwise.complete.obs") ==
cor(algae[,4:18], use = "complete.obs")

```
```{r}
# 只有對角線上的相關係數值相同，其它全部不同！
sum(cor(algae[,4:18], use = "pairwise.complete.obs") ==
cor(algae[,4:18], use = "complete.obs"))

```
```{r}
# 相關係數矩陣符號化，*表PO4與oPO4係數絕對值超過0.9
symnum(cor(algae[,4:18],use = "complete.obs"))
```
## ------------------------------------------------------------------------
```{r}
data(algae)
algae <- algae[-manyNAs(algae),]
# R語言線性建模重要函數lm()
(mdl <- lm(PO4 ~ oPO4, data = algae))
```
```{r}
## ----------------------------
(algae[28,'PO4'] <- 42.897 + 1.293 * algae[28,'oPO4'])

## --
```
```{r}
## ------------------------------------------------------------------------
data(algae)
algae <- algae[-manyNAs(algae),]
# 創造多個PO4遺缺的情境
algae$PO4[29:33] <- NA


```

```{r}
# 考慮連自變數oPO4都遺缺的邊界案例(edge case)(參見1.9節)
algae$oPO4[33] <- NA
```


```{r}
algae[is.na(algae$PO4), c('oPO4','PO4')]

```

```{r}
## ------------------------------------------------------------------------
fillPO4 <- function(oP) { # oP即為自變量oPO4
  # 邊界案例處理
  if (is.na(oP)) return(NA)
  # 從模型物件mdl中取出迴歸係數進行補值計算
  else return(mdl$coef[1] + mdl$coef[2] * oP)
}

## ------------------------------------------------------------------------
# 邏輯值索引、隱式迴圈與自訂函數
algae[is.na(algae$PO4),'PO4']<-sapply(algae[is.na(algae$PO4),'oPO4'], fillPO4)
# 檢視填補完成狀況
algae[28:33, c('PO4', 'oPO4')]


```


```{r}

## ------------------------------------------------------------------------
data(algae)
algae <- algae[-manyNAs(algae),]
# k近鄰填補函數，預設meth引數為加權平均"weighAvg"
algae <- knnImputation(algae, k = 10)

```



```{r}

## ------------------------------------------------------------------------
data(algae)
algae <- algae[-manyNAs(algae),]
# 以近鄰的中位數填補遺缺值
algae <- knnImputation(algae,k=10, meth='median')


algae



```
```{r}
## ----fig.align="center", fig.cap = "\\label{fig:algae_mxPH_season}不同季節下最大酸鹼值mxPH的散佈狀況"----
data(algae)
algae <- algae[-manyNAs(algae),]
# 重要的建議套件
library(lattice)
# 更改默認的因子水準順序(預設是照字母順序)
algae$season <- factor(algae$season,levels =
c('spring','summer','autumn','winter'))
# mxPH條件式直方圖，依季節分層
histogram(~ mxPH | season, data = algae)

```

```{r}
## ----fig.align="center", fig.cap = "\\label{fig:algae_mxPH_size}不同河流大小下最大酸鹼值mxPH的散佈狀況"----
# mxPH條件式直方圖，依河流大小分層
histogram(~ mxPH | size, data = algae)

```

```{r}
## ------------------------------------------------------------------------
# mxPH遺缺該筆樣本的size為small
algae[is.na(algae$mxPH), 'size']
# 抓取size為small的所有樣本，計算平均mxPH值(顯然較低！)
mean(algae[algae$size == "small", 'mxPH'], na.rm = T)


```
## ----fig.align="center", fig.cap =
```{r}

```

```{r}
 "\\label{fig:algae_mxPH_size_speed}不同河流大小與流速下最大酸鹼值mxPH的散佈狀況"----
# 多因子變數的條件式直方圖，以*串接兩個分組變數
histogram(~ mxPH | size*speed, data = algae)

```
## ----fig.align="center", fig.cap = "\\label{fig:algae_mxPH_size_speed_strip}不同河流大小與流速下最大酸鹼值mxPH的點條圖"----
# 兩個因子變數，一個數值變數的點條圖
# 注意jitter=T是為了避免於同處過度繪製(overplotting)!

```{r}

stripplot(size ~ mxPH | speed, data = algae, jitter = T)

```

## 2.2 資料摘要與彙總 ####
## 2.2.1 摘要統計量 ####
## ----warning=FALSE, message=FALSE----
```{r}
library(nutshell)

data(dow30)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
